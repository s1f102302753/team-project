<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - è‡ªæ²»ä½“ã‚µãƒãƒ¼ãƒˆ</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { text-align: center; color: #333; }
        
        /* è·å“¡ç”¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .upload-section { 
            background-color: #e3f2fd; /* è–„ã„é’è‰² */
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 30px; 
            border: 2px dashed #2196f3;
        }
        
        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .chat-section { 
            background-color: #fff; 
            border: 1px solid #ddd; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #chatbox { 
            background: #f9f9f9; 
            padding: 15px; 
            border: 1px solid #eee; 
            min-height: 200px; 
            max-height: 500px;
            overflow-y: auto;
            margin-top: 15px; 
            white-space: pre-wrap; 
            border-radius: 4px;
        }

        input[type="text"] { width: 70%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; background-color: #2196f3; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:hover { background-color: #1976d2; }
        
        .user-msg { color: #007bff; font-weight: bold; display: block; margin-top: 10px; }
        .bot-msg { color: #333; display: block; margin-top: 5px; }
        .loading { color: #666; font-style: italic; }
        .error { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>

<h1>è‡ªæ²»ä½“AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</h1>

{% if user.is_authenticated and user.is_official %}
    <div class="upload-section">
        <h3>ğŸ“‚ è³‡æ–™ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè·å“¡å°‚ç”¨æ©Ÿèƒ½ï¼‰</h3>
        <p style="margin-top:0;"><small>â€»PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€AIãŒãã®å†…å®¹ã‚’å­¦ç¿’ã—ã€ä½æ°‘ã‹ã‚‰ã®è³ªå•ã«ç­”ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</small></p>
        
        <form id="upload-form" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" id="pdf-file" name="pdf" accept=".pdf" required>
            <button type="submit">å­¦ç¿’ã•ã›ã‚‹</button>
        </form>
        <div id="upload-status" style="margin-top: 10px; font-weight: bold;"></div>
    </div>
{% endif %}

<div class="chat-section">
    <h3>ğŸ’¬ è³ªå•ã‚³ãƒ¼ãƒŠãƒ¼</h3>
    <form id="chat-form">
        <input type="text" id="question" name="question" placeholder="ä¾‹: ã”ã¿ã®å‡ºã—æ–¹ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„" required>
        <button type="submit">é€ä¿¡</button>
    </form>

    <div id="chatbox">ã“ã“ã«AIã¨ã®ä¼šè©±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</div>
</div>

<script>
    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
    // ä½æ°‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€upload-formè¦ç´ è‡ªä½“ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ifæ–‡ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™
    const uploadForm = document.getElementById('upload-form');
    
    if (uploadForm) {
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const statusDiv = document.getElementById('upload-status');
            
            statusDiv.style.color = "#333";
            statusDiv.innerText = "â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼†å­¦ç¿’ä¸­...ã“ã‚Œã«ã¯æ•°ç§’ã€œæ•°åˆ†ã‹ã‹ã‚Šã¾ã™...";
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
            const btn = this.querySelector('button');
            btn.disabled = true;

            try {
                const response = await fetch('/chatbot/upload/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData
                });
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.style.color = "green";
                    statusDiv.innerText = "âœ… å­¦ç¿’å®Œäº†: " + data.filename;
                    this.reset();
                } else {
                    statusDiv.style.color = "red";
                    statusDiv.innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + (data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
                }
            } catch (error) {
                statusDiv.style.color = "red";
                statusDiv.innerText = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                console.error(error);
            } finally {
                btn.disabled = false;
            }
        });
    }

    // --- ãƒãƒ£ãƒƒãƒˆé€ä¿¡å‡¦ç† ---
    const chatForm = document.getElementById('chat-form');
    if (chatForm) {
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const questionInput = document.getElementById('question');
            const question = questionInput.value;
            const chatbox = document.getElementById('chatbox');
            const submitBtn = this.querySelector('button');

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’è¡¨ç¤º
            chatbox.innerHTML = `<span class="user-msg">ğŸ§‘ ã‚ãªãŸ: ${question}</span>\n<span class="loading">ğŸ¤– AIãŒè€ƒãˆä¸­...</span>`;
            questionInput.value = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            submitBtn.disabled = true; // é€£æ‰“é˜²æ­¢

            try {
                const response = await fetch('/chatbot/api/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ question: question })
                });

                const data = await response.json();
                
                if (response.ok) {
                    // AIã®å›ç­”ã‚’è¡¨ç¤ºï¼ˆMarkdownãªã©ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯marked.jsç­‰ãŒå¿…è¦ã§ã™ãŒã€ã“ã“ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºï¼‰
                    chatbox.innerHTML = `<span class="user-msg">ğŸ§‘ ã‚ãªãŸ: ${question}</span>\n\n<span class="bot-msg">ğŸ¤– AI: \n${data.answer}</span>`;
                } else {
                    chatbox.innerHTML = `<span class="user-msg">ğŸ§‘ ã‚ãªãŸ: ${question}</span>\n\n<span class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}</span>`;
                }
            } catch (error) {
                chatbox.innerHTML = `<span class="user-msg">ğŸ§‘ ã‚ãªãŸ: ${question}</span>\n\n<span class="error">âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</span>`;
                console.error(error);
            } finally {
                submitBtn.disabled = false;
            }
        });
    }
</script>

</body>
</html>
